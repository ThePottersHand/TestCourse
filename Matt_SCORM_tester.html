<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standalone Browser SCORM Player</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Smooth Height Transition */
        .transition-height { transition: height 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between shrink-0 z-10 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg text-white">
                <i data-lucide="cloud-lightning" width="20" height="20"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Browser SCORM Player</h1>
                <p class="text-xs text-slate-500">Local Persistence â€¢ SCORM 1.2 & 2004</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 text-sm bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200">
                <i data-lucide="settings" width="14" height="14" class="text-slate-500"></i>
                <span class="text-slate-600 font-medium">API Mode:</span>
                <select id="scorm-version" class="bg-transparent border-none outline-none font-bold text-blue-600 cursor-pointer text-sm">
                    <option value="1.2">SCORM 1.2</option>
                    <option value="2004">SCORM 2004</option>
                </select>
            </div>

            <label class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md cursor-pointer transition-colors shadow-sm active:translate-y-0.5">
                <i data-lucide="upload" width="16" height="16"></i>
                <span class="text-sm font-medium">Upload ZIP(s)</span>
                <input type="file" id="file-upload" accept=".zip" multiple class="hidden" />
            </label>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Sidebar -->
        <div class="w-80 bg-white border-r border-slate-200 flex flex-col shrink-0 z-0">
            <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Library</h2>
                <span id="course-count" class="text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-full hidden">0</span>
            </div>
            
            <div id="sidebar-content" class="flex-1 overflow-y-auto p-2 space-y-4">
                <div class="h-full flex flex-col items-center justify-center text-center p-6 text-slate-400">
                    <i data-lucide="layers" width="48" height="48" class="mb-4 opacity-20"></i>
                    <p class="text-sm">Upload one or more SCORM .zip files to build your library</p>
                </div>
            </div>
        </div>

        <!-- Player Area -->
        <div class="flex-1 flex flex-col bg-slate-200 relative">
            <!-- Placeholder -->
            <div id="placeholder-view" class="flex-1 flex flex-col items-center justify-center text-slate-400">
                <div class="text-center max-w-md p-8 border-2 border-dashed border-slate-300 rounded-xl bg-slate-100/50">
                    <i data-lucide="terminal" width="48" height="48" class="mx-auto mb-4 opacity-20"></i>
                    <h3 class="text-lg font-semibold text-slate-600 mb-2">Ready to Launch</h3>
                    <p class="text-sm">Select a module from the sidebar. Progress is saved automatically.</p>
                </div>
            </div>
            
            <!-- Loader -->
            <div id="loader" class="hidden absolute inset-0 bg-white/80 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
                <i data-lucide="refresh-cw" width="40" height="40" class="animate-spin text-blue-600 mb-3"></i>
                <p id="loader-text" class="text-slate-600 font-medium animate-pulse">Processing...</p>
            </div>

            <!-- Iframe -->
            <iframe id="content-frame" class="w-full h-full border-none bg-white hidden" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
        </div>
    </div>

    <!-- Debug Console (Collapsible) -->
    <div id="console-panel" class="h-64 bg-slate-900 text-slate-200 flex flex-col shrink-0 border-t border-slate-700 z-20 transition-height">
        <div class="flex items-center justify-between px-4 py-2 bg-slate-800 border-b border-slate-700 cursor-pointer select-none" onclick="toggleConsole()">
            <div class="flex items-center gap-2">
                <i data-lucide="terminal" width="14" height="14" class="text-green-400"></i>
                <span class="text-xs font-mono font-bold tracking-wider">LMS DEBUG CONSOLE</span>
            </div>
            <div class="flex items-center gap-3">
                <button id="clear-logs" class="text-xs hover:text-white text-slate-400 flex items-center gap-1 transition-colors" onclick="event.stopPropagation()">
                    <i data-lucide="ban" width="12" height="12"></i> Clear
                </button>
                <div id="console-toggle-icon" class="text-slate-400 hover:text-white transition-transform">
                    <i data-lucide="chevron-down" width="16" height="16"></i>
                </div>
            </div>
        </div>
        <div id="log-container" class="flex-1 overflow-y-auto p-4 font-mono text-xs space-y-1.5 scroll-smooth">
            <span class="text-slate-600 italic">Waiting for API calls...</span>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // --- GLOBALS ---
        let courses = []; 
        let activeZip = null; 
        let activeResource = null;
        let scormVersion = '1.2';
        let consoleOpen = true;
        let currentCourseId = null; // For persistence key
        
        // --- DOM ELEMENTS ---
        const dom = {
            fileInput: document.getElementById('file-upload'),
            versionSelect: document.getElementById('scorm-version'),
            sidebar: document.getElementById('sidebar-content'),
            placeholder: document.getElementById('placeholder-view'),
            iframe: document.getElementById('content-frame'),
            loader: document.getElementById('loader'),
            loaderText: document.getElementById('loader-text'),
            logs: document.getElementById('log-container'),
            clearLogsBtn: document.getElementById('clear-logs'),
            courseCount: document.getElementById('course-count'),
            consolePanel: document.getElementById('console-panel'),
            consoleToggleIcon: document.getElementById('console-toggle-icon')
        };

        // --- UI FUNCTIONS ---
        function initIcons() { if (typeof lucide !== 'undefined') lucide.createIcons(); }
        
        function toggleConsole() {
            consoleOpen = !consoleOpen;
            if (consoleOpen) {
                dom.consolePanel.classList.remove('h-10');
                dom.consolePanel.classList.add('h-64');
                dom.consoleToggleIcon.style.transform = 'rotate(0deg)';
            } else {
                dom.consolePanel.classList.remove('h-64');
                dom.consolePanel.classList.add('h-10'); 
                dom.consoleToggleIcon.style.transform = 'rotate(180deg)';
            }
        }

        function addLog(method, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = { 'success': 'text-green-400', 'warning': 'text-yellow-400', 'error': 'text-red-400', 'info': 'text-blue-300', 'system': 'text-slate-400' };
            const row = document.createElement('div');
            row.className = "flex gap-3 border-b border-slate-800/50 pb-1 mb-1 last:border-0 animate-in fade-in slide-in-from-left-2 duration-200";
            row.innerHTML = `<span class="text-slate-500 w-20 shrink-0">${timestamp}</span><span class="w-32 shrink-0 font-bold ${colors[type] || colors.info}">${method}</span><span class="${type === 'error' ? 'text-red-300' : 'text-slate-300'} break-all flex-1">${message}</span>`;
            if(dom.logs.querySelector('span.italic')) dom.logs.innerHTML = '';
            dom.logs.insertBefore(row, dom.logs.firstChild);
        }

        // --- SCORM API (PERSISTENT & PERMISSIVE) ---
        class ScormAPI {
            constructor(version = '1.2') {
                this.version = version;
                this.data = {}; // Will be loaded from storage
            }

            // Load data for specific course
            load(courseId) {
                this.courseId = courseId;
                const stored = localStorage.getItem(`scorm_data_${courseId}`);
                if (stored) {
                    this.data = JSON.parse(stored);
                    addLog('System', 'Restored previous session data.', 'success');
                } else {
                    this.data = this.getInitialData();
                    addLog('System', 'New session created.', 'info');
                }
            }

            reset(courseId) {
                localStorage.removeItem(`scorm_data_${courseId}`);
                if(this.courseId === courseId) {
                    this.data = this.getInitialData();
                }
                addLog('System', 'Course progress reset.', 'warning');
            }

            save() {
                if(this.courseId) {
                    localStorage.setItem(`scorm_data_${this.courseId}`, JSON.stringify(this.data));
                }
            }

            getInitialData() {
                return {
                    'cmi.core.student_id': 'student_1', 
                    'cmi.core.student_name': 'User, Local',
                    'cmi.core.lesson_status': 'not attempted', 
                    'cmi.suspend_data': '',
                    'cmi.core.score.raw': '', 
                    'cmi.completion_status': 'unknown', // 2004
                    'cmi.success_status': 'unknown',    // 2004
                    'cmi.entry': 'ab-initio'
                };
            }

            log(m, msg, t='info') { addLog(m, msg, t); }
            
            // SCORM 1.2
            LMSInitialize(p) { this.log('LMSInitialize', `Param: "${p}"`, 'success'); return "true"; }
            LMSFinish(p) { 
                this.save(); 
                this.log('LMSFinish', `Session Finished. Data saved.`, 'success'); 
                return "true"; 
            }
            LMSGetValue(e) { 
                const v = this.data[e] || ""; 
                this.log('LMSGetValue', `Get: ${e} -> "${v}"`); 
                return v; 
            }
            LMSSetValue(e, v) { 
                // Permissive Mode: Accept ANY key starting with cmi
                this.data[e] = v;
                this.save(); // Auto-save on set (safer for standalone)
                this.log('LMSSetValue', `Set: ${e} = "${v}"`, 'warning'); 
                return "true"; 
            }
            LMSCommit(p) { 
                this.save(); 
                this.log('LMSCommit', `Data committed to LocalStorage`, 'success'); 
                return "true"; 
            }
            LMSGetLastError() { return "0"; } 
            LMSGetErrorString(c) { return "No error"; } 
            LMSGetDiagnostic(c) { return "No diagnostic"; }

            // SCORM 2004 (Mapped to same storage)
            Initialize(p) { return this.LMSInitialize(p); }
            Terminate(p) { return this.LMSFinish(p); }
            GetValue(e) { return this.LMSGetValue(e); }
            SetValue(e, v) { return this.LMSSetValue(e, v); }
            Commit(p) { return this.LMSCommit(p); }
            GetLastError() { return this.LMSGetLastError(); }
            GetErrorString(c) { return this.LMSGetErrorString(c); }
            GetDiagnostic(c) { return this.LMSGetDiagnostic(c); }
        }

        let apiInstance = null;

        function initializeAPI() {
            apiInstance = new ScormAPI(scormVersion);
            window.API = apiInstance;           // SCORM 1.2
            window.API_1484_11 = apiInstance;   // SCORM 2004
            addLog('System', `API Attached (${scormVersion})`, 'system');
        }

        // --- FILE HANDLING ---
        
        async function handleFileUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            if (typeof JSZip === 'undefined') return alert("JSZip not loaded.");

            dom.loader.classList.remove('hidden');
            dom.loaderText.textContent = `Processing ${files.length} file(s)...`;
            addLog('System', `Batch upload started...`, 'system');

            setTimeout(async () => {
                try {
                    const newCourses = [];
                    for (const file of files) {
                        try {
                            const zip = new JSZip();
                            const zipContent = await zip.loadAsync(file);
                            const filesInZip = Object.keys(zipContent.files);
                            const manifestKey = filesInZip.find(n => n.toLowerCase().endsWith('imsmanifest.xml'));
                            
                            if (!manifestKey) {
                                addLog('Error', `Skipped ${file.name}: No manifest`, 'error');
                                continue;
                            }

                            const xmlText = await zipContent.file(manifestKey).async("text");
                            const { title, items } = parseManifest(xmlText, file.name);
                            
                            // Generate a consistent ID based on filename for persistence
                            const courseId = file.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();

                            newCourses.push({
                                id: courseId, 
                                filename: file.name,
                                title: title || file.name,
                                items: items,
                                zip: zipContent
                            });
                            addLog('System', `Processed: ${title}`, 'success');
                        } catch (err) {
                            addLog('Error', `Failed ${file.name}: ${err.message}`, 'error');
                        }
                    }
                    courses = [...courses, ...newCourses];
                    renderLibrary();
                } catch (err) {
                    addLog('Error', 'Critical error: ' + err.message, 'error');
                } finally {
                    dom.loader.classList.add('hidden');
                    dom.fileInput.value = '';
                }
            }, 100);
        }

        function parseManifest(xmlText, filename) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const orgTitle = xmlDoc.getElementsByTagName('organization')[0]?.getElementsByTagName('title')[0]?.textContent 
                           || xmlDoc.getElementsByTagName('title')[0]?.textContent;

            const resources = {};
            Array.from(xmlDoc.getElementsByTagName('resource')).forEach(res => {
                resources[res.getAttribute('identifier')] = { 
                    href: res.getAttribute('href'), 
                    type: res.getAttribute('type') 
                };
            });

            const items = Array.from(xmlDoc.getElementsByTagName('item')).map(item => {
                const title = item.getElementsByTagName('title')[0]?.textContent || "Untitled";
                const ref = item.getAttribute('identifierref');
                return { 
                    identifier: item.getAttribute('identifier'), 
                    title: title, 
                    href: resources[ref]?.href 
                };
            }).filter(i => i.href);
            return { title: orgTitle, items: items };
        }

        function renderLibrary() {
            dom.sidebar.innerHTML = '';
            dom.courseCount.textContent = courses.length;
            dom.courseCount.classList.remove('hidden');

            if (courses.length === 0) {
                dom.sidebar.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-6 text-slate-400"><i data-lucide="layers" width="48" height="48" class="mb-4 opacity-20"></i><p class="text-sm">Library empty</p></div>`;
                return;
            }

            courses.forEach(course => {
                const courseDiv = document.createElement('div');
                courseDiv.className = "mb-4 border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm";
                
                const header = document.createElement('div');
                header.className = "bg-slate-50 px-3 py-2 border-b border-slate-100 flex items-center justify-between";
                
                // Header with Reset Button
                header.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <i data-lucide="package" width="14" height="14" class="text-slate-400 shrink-0"></i>
                        <h3 class="text-xs font-bold text-slate-600 truncate uppercase tracking-wide" title="${course.title}">${course.title}</h3>
                    </div>
                    <button class="reset-btn text-[10px] flex items-center gap-1 text-slate-400 hover:text-red-500 transition-colors" title="Reset Progress">
                        <i data-lucide="rotate-ccw" width="12" height="12"></i> Reset
                    </button>
                `;
                
                // Attach Reset Listener
                header.querySelector('.reset-btn').onclick = (e) => {
                    e.stopPropagation();
                    if(confirm("Reset progress for this course?")) {
                        apiInstance.reset(course.id);
                        // Reload if currently playing
                        if(currentCourseId === course.id && dom.iframe.src) {
                            dom.iframe.src = dom.iframe.src; 
                        }
                    }
                };

                courseDiv.appendChild(header);

                const list = document.createElement('div');
                list.className = "p-1 space-y-0.5";

                course.items.forEach(item => {
                    const btn = document.createElement('button');
                    const isPlaying = activeResource === item.identifier + course.id;
                    
                    btn.className = `w-full text-left px-2 py-2 rounded flex items-start gap-2 transition-all group ${
                        isPlaying ? 'bg-blue-50 text-blue-700' : 'hover:bg-slate-50 text-slate-600'
                    }`;
                    
                    btn.innerHTML = `
                        <div class="icon-wrapper mt-0.5 ${isPlaying ? 'text-blue-600' : 'text-slate-300 group-hover:text-slate-400'}">
                            ${isPlaying ? '<i data-lucide="play-circle" width="14" height="14"></i>' : '<i data-lucide="file" width="14" height="14"></i>'}
                        </div>
                        <div class="min-w-0">
                            <p class="text-xs font-medium leading-tight truncate">${item.title}</p>
                        </div>
                    `;
                    btn.onclick = () => launchItem(item, course);
                    list.appendChild(btn);
                });
                courseDiv.appendChild(list);
                dom.sidebar.appendChild(courseDiv);
            });
            initIcons();
        }

        // --- LAUNCH & REWRITE LOGIC ---

        function resolvePath(baseFile, targetPath) {
            const basePath = baseFile.includes('/') ? baseFile.substring(0, baseFile.lastIndexOf('/')) : '';
            let cleanTarget = targetPath.replace(/^\.\//, '');
            const parts = (basePath + '/' + cleanTarget).split('/');
            const stack = [];
            for (let part of parts) {
                if (part === '' || part === '.') continue;
                if (part === '..') { if (stack.length > 0) stack.pop(); }
                else stack.push(part);
            }
            return stack.join('/');
        }

        function findFileInZip(path) {
            if (!activeZip) return null;
            if (activeZip.file(path)) return activeZip.file(path);
            const clean = path.replace(/^\.\//, '');
            if (activeZip.file(clean)) return activeZip.file(clean);
            const lower = clean.toLowerCase();
            const match = Object.keys(activeZip.files).find(k => k.toLowerCase() === lower);
            return match ? activeZip.file(match) : null;
        }

        async function processCSS(cssContent, cssPath) {
            const urlRegex = /url\s*\(\s*['"]?([^'"]+)['"]?\s*\)/gi;
            let match;
            const replacements = [];
            
            while ((match = urlRegex.exec(cssContent)) !== null) {
                const originalUrl = match[1];
                if (!originalUrl.startsWith('data:') && !originalUrl.startsWith('http')) {
                    const absolutePath = resolvePath(cssPath, originalUrl);
                    const fileEntry = findFileInZip(absolutePath);
                    if (fileEntry) {
                        const blob = await fileEntry.async("blob");
                        // Expanded MIME types
                        let mime = 'application/octet-stream';
                        if(absolutePath.match(/\.png$/i)) mime = 'image/png';
                        else if(absolutePath.match(/\.jpe?g$/i)) mime = 'image/jpeg';
                        else if(absolutePath.match(/\.gif$/i)) mime = 'image/gif';
                        else if(absolutePath.match(/\.svg$/i)) mime = 'image/svg+xml';
                        else if(absolutePath.match(/\.(woff2?|ttf|otf|eot)$/i)) mime = 'font/woff2';
                        
                        const blobUrl = URL.createObjectURL(blob.slice(0, blob.size, mime));
                        replacements.push({ start: match.index, end: match.index + match[0].length, newVal: `url('${blobUrl}')` });
                    }
                }
            }
            
            let newCss = cssContent;
            for (let i = replacements.length - 1; i >= 0; i--) {
                const r = replacements[i];
                newCss = newCss.substring(0, r.start) + r.newVal + newCss.substring(r.end);
            }
            return newCss;
        }

        async function launchItem(item, course) {
            activeResource = item.identifier + course.id;
            activeZip = course.zip;
            currentCourseId = course.id;
            
            // Load persistent data
            apiInstance.load(course.id);
            renderLibrary();

            dom.loader.classList.remove('hidden');
            dom.iframe.classList.add('hidden');
            dom.placeholder.classList.add('hidden');

            setTimeout(async () => {
                try {
                    const fileEntry = findFileInZip(item.href);
                    if (!fileEntry) throw new Error(`Entry file ${item.href} not found`);
                    
                    const htmlContent = await fileEntry.async("string");
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, "text/html");

                    // Helper to rewrite attributes
                    const processElements = async (tagName, attr) => {
                        const els = Array.from(doc.getElementsByTagName(tagName));
                        for (const el of els) {
                            const val = el.getAttribute(attr);
                            if (val && !val.startsWith('http') && !val.startsWith('//') && !val.startsWith('data:') && !val.startsWith('#') && !val.startsWith('javascript:') && !val.startsWith('mailto:')) {
                                const absPath = resolvePath(item.href, val);
                                const entry = findFileInZip(absPath);
                                if (entry) {
                                    if (val.toLowerCase().endsWith('.css') || (tagName === 'link' && el.getAttribute('rel') === 'stylesheet')) {
                                        const cssText = await entry.async("string");
                                        const newCss = await processCSS(cssText, absPath);
                                        const blob = new Blob([newCss], { type: 'text/css' });
                                        el.setAttribute(attr, URL.createObjectURL(blob));
                                    } else {
                                        const blob = await entry.async("blob");
                                        let mime = 'application/octet-stream';
                                        if(absPath.endsWith('.js')) mime = 'application/javascript';
                                        else if(absPath.endsWith('.json')) mime = 'application/json';
                                        else if(absPath.endsWith('.xml')) mime = 'text/xml';
                                        else if(absPath.match(/\.mp4$/i)) mime = 'video/mp4';
                                        else if(absPath.match(/\.mp3$/i)) mime = 'audio/mpeg';
                                        else if(absPath.match(/\.pdf$/i)) mime = 'application/pdf';
                                        
                                        const blobUrl = URL.createObjectURL(blob.slice(0, blob.size, mime));
                                        el.setAttribute(attr, blobUrl);
                                    }
                                }
                            }
                        }
                    };

                    await processElements('link', 'href');
                    await processElements('script', 'src');
                    await processElements('img', 'src');
                    await processElements('iframe', 'src');
                    await processElements('frame', 'src');
                    await processElements('source', 'src'); // Video/Audio sources

                    const finalHtml = doc.documentElement.outerHTML;
                    const mainBlob = new Blob([finalHtml], { type: 'text/html' });
                    dom.iframe.src = URL.createObjectURL(mainBlob);
                    dom.iframe.classList.remove('hidden');
                    addLog('System', `Launched: ${item.title}`, 'info');

                } catch (e) {
                    addLog('Error', e.message, 'error');
                } finally {
                    dom.loader.classList.add('hidden');
                }
            }, 50);
        }

        // --- INIT ---
        window.onload = () => { initializeAPI(); initIcons(); dom.fileInput.value = ''; };
        dom.fileInput.addEventListener('change', handleFileUpload);
        dom.versionSelect.addEventListener('change', (e) => { scormVersion = e.target.value; initializeAPI(); });
        dom.clearLogsBtn.addEventListener('click', (e) => { e.stopPropagation(); dom.logs.innerHTML = '<span class="text-slate-600 italic">Waiting...</span>'; });

    </script>
</body>
</html>
